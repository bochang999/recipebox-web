name: Build RecipeBox APK

on:
  push:
    branches: [ main, develop, feature/rebuild-from-template ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  JAVA_VERSION: '17'
  NODE_VERSION: '20'
  
jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Setup Java JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}

    - name: Cache Gradle dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Install Dependencies
      run: |
        npm ci
        npm install -g @capacitor/cli

    - name: Validate PWA Assets
      run: |
        echo "ðŸ” PWAè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª"
        if [ -f "manifest.json" ]; then
          echo "âœ… manifest.json å­˜åœ¨ç¢ºèª"
          cat manifest.json | jq '.' > /dev/null && echo "âœ… JSONå½¢å¼æ­£å¸¸" || exit 1
        else
          echo "âŒ manifest.json ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          exit 1
        fi
        
        if [ -f "sw.js" ]; then
          echo "âœ… Service Workerå­˜åœ¨ç¢ºèª"
        else
          echo "âš ï¸ Service WorkerãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰"
        fi

    - name: Generate Version Tag
      id: version
      run: |
        VERSION_TAG="1.0.${{ github.run_number }}"
        echo "VERSION_TAG=${VERSION_TAG}" >> $GITHUB_ENV
        echo "ðŸ·ï¸ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¿ã‚°: ${VERSION_TAG}"

    - name: Update App Version
      run: |
        # package.jsonã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°
        jq --arg version "${{ env.VERSION_TAG }}" '.version = $version' package.json > package.json.tmp
        mv package.json.tmp package.json
        
        # manifestã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°
        jq --arg version "${{ env.VERSION_TAG }}" '.version = $version' manifest.json > manifest.json.tmp
        mv manifest.json.tmp manifest.json
        
        echo "ðŸ“ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ ${{ env.VERSION_TAG }} ã«æ›´æ–°å®Œäº†"

    - name: Initialize Capacitor Project
      run: |
        echo "ðŸ”§ CapacitoråˆæœŸåŒ–é–‹å§‹"
        
        # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆæœŸåŒ–ï¼ˆæ—¢å­˜è¨­å®šã‚’ä½¿ç”¨ï¼‰
        npx cap init --web-dir ./ || echo "æ—¢ã«åˆæœŸåŒ–æ¸ˆã¿"
        
        # Androidãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¿½åŠ 
        npx cap add android || echo "Androidæ—¢ã«è¿½åŠ æ¸ˆã¿"
        
        echo "âœ… CapacitoråˆæœŸåŒ–å®Œäº†"

    - name: Setup Keystore from GitHub Secrets
      run: |
        echo "ðŸ”‘ ã‚­ãƒ¼ã‚¹ãƒˆã‚¢è¨­å®šé–‹å§‹"
        
        if [ -z "${{ secrets.KEYSTORE_B64 }}" ]; then
          echo "âš ï¸ GitHub Secretsæœªè¨­å®š - ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”¨ã‚­ãƒ¼ã‚¹ãƒˆã‚¢ç”Ÿæˆ"
          keytool -genkeypair -v \
            -keystore template-release.keystore \
            -alias template-key \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -dname "CN=PWA Template,OU=Template,O=Development,L=Tokyo,ST=Tokyo,C=JP" \
            -storepass template123 \
            -keypass template123
          
          echo "KEYSTORE_PASSWORD=template123" >> $GITHUB_ENV
          echo "KEY_ALIAS=template-key" >> $GITHUB_ENV
          echo "KEY_PASSWORD=template123" >> $GITHUB_ENV
        else
          echo "âœ… GitHub Secretsè¨­å®šæ¸ˆã¿ - æœ¬ç•ªã‚­ãƒ¼ã‚¹ãƒˆã‚¢ä½¿ç”¨"
          echo "${{ secrets.KEYSTORE_B64 }}" | base64 --decode > template-release.keystore
          
          echo "KEYSTORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}" >> $GITHUB_ENV
          echo "KEY_ALIAS=${{ secrets.KEY_ALIAS }}" >> $GITHUB_ENV
          echo "KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}" >> $GITHUB_ENV
        fi
        
        echo "ðŸ” ã‚­ãƒ¼ã‚¹ãƒˆã‚¢è¨­å®šå®Œäº†"

    - name: Initialize Capacitor and Sync
      run: |
        echo "ðŸ¤– Capacitor Androidãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ åˆæœŸåŒ–"
        npx cap add android
        echo "ðŸ”„ CapacitoråŒæœŸé–‹å§‹"
        npx cap sync android
        echo "âœ… CapacitoråŒæœŸå®Œäº†"

    - name: Build Android APK
      run: |
        echo "ðŸ—ï¸ Android APK ãƒ“ãƒ«ãƒ‰é–‹å§‹"
        cd android
        
        # Gradleãƒ©ãƒƒãƒ‘ãƒ¼ã«å®Ÿè¡Œæ¨©é™ä»˜ä¸Ž
        chmod +x ./gradlew
        
        # APKãƒ“ãƒ«ãƒ‰
        ./gradlew assembleRelease --stacktrace
        
        echo "âœ… APK ãƒ“ãƒ«ãƒ‰å®Œäº†"

    - name: Sign APK
      run: |
        echo "âœï¸ APKç½²åé–‹å§‹"
        
        cd android/app/build/outputs/apk/release
        
        # APKç½²å
        jarsigner -verbose \
          -keystore ../../../../../template-release.keystore \
          -storepass ${{ env.KEYSTORE_PASSWORD }} \
          -keypass ${{ env.KEY_PASSWORD }} \
          -signedjar app-release-signed.apk \
          app-release-unsigned.apk \
          ${{ env.KEY_ALIAS }}
        
        # zipalignå®Ÿè¡Œ
        $ANDROID_HOME/build-tools/$(ls $ANDROID_HOME/build-tools | tail -1)/zipalign -v 4 \
          app-release-signed.apk \
          pwatemplate_${{ env.VERSION_TAG }}.apk
        
        echo "ðŸŽ¯ ç½²åå®Œäº†: pwatemplate_${{ env.VERSION_TAG }}.apk"

    - name: Verify APK
      run: |
        echo "ðŸ” APKæ¤œè¨¼é–‹å§‹"
        
        APK_PATH="android/app/build/outputs/apk/release/pwatemplate_${{ env.VERSION_TAG }}.apk"
        
        if [ -f "$APK_PATH" ]; then
          APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
          echo "âœ… APKç”ŸæˆæˆåŠŸ: $APK_SIZE"
          
          # APKæƒ…å ±è¡¨ç¤º
          $ANDROID_HOME/build-tools/$(ls $ANDROID_HOME/build-tools | tail -1)/aapt dump badging "$APK_PATH" | head -5
        else
          echo "âŒ APKç”Ÿæˆå¤±æ•—"
          exit 1
        fi

    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: PWA-Template-APK-${{ env.VERSION_TAG }}
        path: android/app/build/outputs/apk/release/pwatemplate_${{ env.VERSION_TAG }}.apk
        retention-days: 30

    - name: Create Release (on main branch)
      if: github.ref == 'refs/heads/main'
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ env.VERSION_TAG }}
        release_name: PWA Template v${{ env.VERSION_TAG }}
        body: |
          ## ðŸ“± PWA Template APK v${{ env.VERSION_TAG }}
          
          ### âœ¨ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ©Ÿèƒ½
          - ðŸ“± PWAâ†’APKå¤‰æ›ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
          - ðŸŽ¨ ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–UIè¨­è¨ˆ
          - ðŸ’¾ LocalStorageè‡ªå‹•ä¿å­˜
          - âš™ï¸ è¨­å®šã‚·ã‚¹ãƒ†ãƒ å®Œå‚™
          - ðŸ”„ Service Workerå¯¾å¿œ
          
          ### ðŸ› ï¸ é–‹ç™ºç’°å¢ƒ
          - Node.js ${{ env.NODE_VERSION }}
          - Java JDK ${{ env.JAVA_VERSION }}
          - Capacitor 5.x
          - GitHub Actionsè‡ªå‹•ãƒ“ãƒ«ãƒ‰
          
          ### ðŸ“‹ ä½¿ç”¨æ–¹æ³•
          1. ã“ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ•ã‚©ãƒ¼ã‚¯/ã‚¯ãƒ­ãƒ¼ãƒ³
          2. `npm install` ã§ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          3. `npm run dev` ã§é–‹ç™ºé–‹å§‹
          4. GitHubã«ãƒ—ãƒƒã‚·ãƒ¥ã§è‡ªå‹•APKç”Ÿæˆ
          
          **APKãƒ•ã‚¡ã‚¤ãƒ«**: PWA-Template-APK-${{ env.VERSION_TAG }}
        draft: false
        prerelease: false

    - name: Build Summary
      run: |
        echo "## ðŸŽ¯ PWA Template APK Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| é …ç›® | å€¤ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
        echo "| ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | ${{ env.VERSION_TAG }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Node.js | ${{ env.NODE_VERSION }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Java JDK | ${{ env.JAVA_VERSION }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ãƒ–ãƒ©ãƒ³ãƒ | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ã‚³ãƒŸãƒƒãƒˆ | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ æˆæžœç‰©" >> $GITHUB_STEP_SUMMARY
        echo "- APKãƒ•ã‚¡ã‚¤ãƒ«: \`pwatemplate_${{ env.VERSION_TAG }}.apk\`" >> $GITHUB_STEP_SUMMARY
        echo "- ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ: PWA-Template-APK-${{ env.VERSION_TAG }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸš€ **APKãƒ“ãƒ«ãƒ‰ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼**" >> $GITHUB_STEP_SUMMARY
name: Build Signed Android APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Setup Java JDK
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Install Dependencies
        run: npm ci

      - name: Build Web Assets
        run: npm run build

      - name: Decode and Verify Keystore
        id: decode_keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_FILE }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        run: |
          if [ -z "$KEYSTORE_BASE64" ]; then
            echo "âŒ KEYSTORE_FILE secret is not set."
            exit 1
          fi
          
          echo "Decoding keystore..."
          # ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®ãƒ«ãƒ¼ãƒˆã«ã‚­ãƒ¼ã‚¹ãƒˆã‚¢ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®
          KEYSTORE_PATH="${{ github.workspace }}/keystore.jks"
          echo "$KEYSTORE_BASE64" | base64 --decode > $KEYSTORE_PATH
          
          echo "Verifying keystore..."
          # keytoolã§ã‚­ãƒ¼ã‚¹ãƒˆã‚¢ãŒæœ‰åŠ¹ã‹ãƒã‚§ãƒƒã‚¯ã€‚å¤±æ•—ã—ãŸã‚‰å³åº§ã«çµ‚äº†
          keytool -list -keystore $KEYSTORE_PATH -storepass "$KEYSTORE_PASSWORD" || exit 1
          
          echo "âœ… Keystore is valid."
          # å¾Œç¶šã®ã‚¹ãƒ†ãƒƒãƒ—ã§ãƒ‘ã‚¹ã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«å‡ºåŠ›ã«è¨­å®š
          echo "keystore_path=$KEYSTORE_PATH" >> $GITHUB_OUTPUT

      - name: Initialize Clean Android Platform and Sync
        run: |
          # å†ªç­‰æ€§ã‚’ä¿è¨¼ã™ã‚‹ãŸã‚ã€æ—¢å­˜ã®androidãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒã‚ã‚Œã°å®Œå…¨ã«å‰Šé™¤ã™ã‚‹
          if [ -d "android" ]; then
            echo "âš ï¸ Removing existing android/ directory for a clean build..."
            rm -rf android/
          fi
          
          # ã‚¯ãƒªãƒ¼ãƒ³ãªçŠ¶æ…‹ã§Androidãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’è¿½åŠ ï¼ˆã“ã“ã§gradlewãŒç”Ÿæˆã•ã‚Œã‚‹ï¼‰
          echo "ðŸ“ Creating a fresh Android platform..."
          npx cap add android
          
          # Webè³‡ç”£ã‚’Androidãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã«åŒæœŸ
          echo "ðŸ”„ Syncing web assets..."
          npx cap sync android
          echo "âœ… Android Platform is ready."
          ls -la android/

      - name: Build Signed Android APK
        working-directory: ./android
        env:
          # å‰ã®ã‚¹ãƒ†ãƒƒãƒ—ã§æ¤œè¨¼ã—ãŸã‚­ãƒ¼ã‚¹ãƒˆã‚¢ã®ãƒ‘ã‚¹ã‚’ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦æ¸¡ã™
          KEYSTORE_FILE: ${{ steps.decode_keystore.outputs.keystore_path }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          echo "=== Starting Gradle build with signing config ==="
          chmod +x gradlew
          # --stacktraceã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã«è©³ç´°ãªãƒ­ã‚°ã‚’å‡ºåŠ›
          ./gradlew assembleRelease --stacktrace

      - name: Rename and Prepare Release APK
        id: rename_apk
        run: |
          echo "Searching for signed APK..."
          # ç½²åæ¸ˆã¿APKã®ãƒ‘ã‚¹ã‚’ç‰¹å®š
          SIGNED_APK_PATH=$(find android/app/build/outputs/apk/release -name "app-release.apk" -type f)
          if [ -z "$SIGNED_APK_PATH" ]; then
            echo "âŒ Signed APK (app-release.apk) not found!"
            echo "Listing available APKs in release directory:"
            find android/app/build/outputs/apk/release -name "*.apk" -type f || echo "No APKs found."
            exit 1
          fi
          # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã‚’è¨ˆç®—
          MAJOR_VERSION=1
          MINOR_VERSION=$(printf "%02d" ${{ github.run_number }})
          VERSION="v${MAJOR_VERSION}.${MINOR_VERSION}"
          
          # æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«åã§ã‚³ãƒ”ãƒ¼
          NEW_APK_NAME="RecipeBox-${VERSION}.apk"
          cp "$SIGNED_APK_PATH" "$NEW_APK_NAME"
          
          echo "âœ… APK successfully renamed to ${NEW_APK_NAME}"
          
          # å¾Œç¶šã®ãƒªãƒªãƒ¼ã‚¹ã‚¹ãƒ†ãƒƒãƒ—ã®ãŸã‚ã«ãƒ•ã‚¡ã‚¤ãƒ«åã¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å‡ºåŠ›
          echo "apk_name=${NEW_APK_NAME}" >> $GITHUB_OUTPUT
          echo "version_tag=${VERSION}" >> $GITHUB_OUTPUT

      - name: Upload APK as Artifact
        uses: actions/upload-artifact@v3
        with:
          name: ${{ steps.rename_apk.outputs.apk_name }}
          path: ${{ steps.rename_apk.outputs.apk_name }}
          retention-days: 30